<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Fridge Manager - 수정</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="my.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
 
  (function (w){
  const DEFAULT = {
    nextId: 11, // 기본 10개가 있으므로 11부터
    items: [
      {id:1,name:'계란',qty:30,type:'냉장',status:'좋음',buy:'2025-09-25',expire:'2025-10-10',price:7800,note:''},
      {id:2,name:'닭가슴살',qty:6,type:'냉동',status:'좋음',buy:'2025-09-18',expire:'2025-12-01',price:12000,note:''},
      {id:3,name:'상추',qty:2,type:'냉장',status:'빨리 먹어야 함',buy:'2025-09-29',expire:'2025-10-03',price:2500,note:'샐러드'},
      {id:4,name:'우유',qty:1,type:'냉장',status:'빨리 먹어야 함',buy:'2025-09-28',expire:'2025-10-02',price:2300,note:''},
      {id:5,name:'만두',qty:2,type:'냉동',status:'좋음',buy:'2025-09-20',expire:'2026-03-01',price:9800,note:''},
      {id:6,name:'베이컨',qty:1,type:'냉장',status:'좋음',buy:'2025-09-27',expire:'2025-10-15',price:5200,note:''},
      {id:7,name:'요거트',qty:4,type:'냉장',status:'좋음',buy:'2025-09-30',expire:'2025-10-07',price:4800,note:''},
      {id:8,name:'아이스크림',qty:5,type:'냉동',status:'좋음',buy:'2025-09-15',expire:'2026-09-15',price:15000,note:''},
      {id:9,name:'돼지고기',qty:2,type:'냉동',status:'좋음',buy:'2025-09-10',expire:'2026-01-10',price:18000,note:''},
      {id:10,name:'치즈',qty:3,type:'냉장',status:'좋음',buy:'2025-09-26',expire:'2025-12-01',price:6200,note:''},
    ]
  };
  
  function load(){
    try{
      if(!w.name) return structuredClone(DEFAULT);
      const obj = JSON.parse(w.name);
      if(!obj || !Array.isArray(obj.items) || !Number.isInteger(obj.nextId)) return structuredClone(DEFAULT);
      return obj;
    }catch(e){ return structuredClone(DEFAULT); }
  }
  function save(db){ w.name = JSON.stringify(db); }
  
  const DB = {
    _state: load(),
    all(){ return this._state.items.slice(); },
    get(id){ return this._state.items.find(x=> String(x.id)===String(id)); },
    add(rec){
      const id = this._state.nextId++;
      const item = { id, ...rec };
      this._state.items.unshift(item);
      save(this._state);
      return item;
    },
    update(id, patch){
      const idx = this._state.items.findIndex(x=> String(x.id)===String(id));
      if(idx<0) return null;
      this._state.items[idx] = { ...this._state.items[idx], ...patch };
      save(this._state);
      return this._state.items[idx];
    },
    remove(id){
      const before = this._state.items.length;
      this._state.items = this._state.items.filter(x=> String(x.id)!==String(id));
      save(this._state);
      return this._state.items.length !== before;
    },
    reset(){ this._state = structuredClone(DEFAULT); save(this._state); }
  };
  w.DB = DB;
  })(window);

  </script>
</head>
<body>


  <div class="container py-4">
    <h1>식품 수정</h1>
    <form id="f" class="bg-white p-3 rounded shadow-sm"></form>
  </div>

  <script>
    const idParam = new URLSearchParams(location.search).get('id');
    const id = Number(idParam);
    const item = DB.get(id);

    function render(){
      if(!item){
        document.getElementById('f').innerHTML =
          '<div class="text-danger">항목을 찾을 수 없습니다.</div>';
        return;
      }
      document.getElementById('f').innerHTML = `
        <div class="row g-3">
          <div class="col-md-6"><label class="form-label">이름 *</label>
            <input name="name" class="form-control" value="${item.name}" required></div>
          <div class="col-md-3"><label class="form-label">수량 *</label>
            <input type="number" name="qty" class="form-control" value="${item.qty}" min="1" step="1" required></div>
          <div class="col-md-3"><label class="form-label">종류 *</label>
            <select name="type" class="form-select" required>
              <option ${item.type==='냉장'?'selected':''}>냉장</option>
              <option ${item.type==='냉동'?'selected':''}>냉동</option>
            </select></div>
          <div class="col-md-4"><label class="form-label">상태 *</label>
            <select name="status" class="form-select" required>
              <option ${item.status==='좋음'?'selected':''}>좋음</option>
              <option ${item.status==='빨리 먹어야 함'?'selected':''}>빨리 먹어야 함</option>
              <option ${item.status==='폐기 예정'?'selected':''}>폐기 예정</option>
            </select></div>
          <div class="col-md-4"><label class="form-label">구매일 *</label>
            <input type="date" name="buy" class="form-control" value="${item.buy}" required></div>
          <div class="col-md-4"><label class="form-label">소비기한 *</label>
            <input type="date" name="expire" class="form-control" value="${item.expire}" required></div>
          <div class="col-md-4"><label class="form-label">가격(원) *</label>
            <!-- step=1: 정수, (disabled/readonly 없음) -->
            <input type="number" name="price" class="form-control" value="${item.price}" min="0" step="1" required>
            <div class="invalid-feedback">0 이상의 정수 금액을 입력하세요</div>
          </div>
          <div class="col-12"><label class="form-label">비고</label>
            <textarea name="note" class="form-control" rows="2">${item.note||''}</textarea></div>
        </div>
        <div class="mt-4 d-flex gap-2">
          <button class="btn btn-primary">확인</button>
          <a href="index.html" class="btn btn-secondary">목록</a>
        </div>
      `;
    }

    function validate(fd, form){
      let ok = true;
      const name = fd.get('name').trim(), nameEl = form.elements['name'];
      if(name.length<2 || name.length>40){ nameEl.classList.add('is-invalid'); ok=false; } else nameEl.classList.remove('is-invalid');

      const qty = Number(fd.get('qty')), qtyEl = form.elements['qty'];
      if(!Number.isInteger(qty) || qty<1){ qtyEl.classList.add('is-invalid'); ok=false; } else qtyEl.classList.remove('is-invalid');

      const buy = fd.get('buy'), exp = fd.get('expire'), today = new Date().toISOString().slice(0,10);
      const bEl=form.elements['buy'], eEl=form.elements['expire'];
      if(!buy || buy>today){ bEl.classList.add('is-invalid'); ok=false; } else bEl.classList.remove('is-invalid');
      if(!exp || (buy && exp<=buy)){ eEl.classList.add('is-invalid'); ok=false; } else eEl.classList.remove('is-invalid');

      const price = Number(fd.get('price')), pEl = form.elements['price'];
      if(!Number.isInteger(price) || price<0){ pEl.classList.add('is-invalid'); ok=false; } else pEl.classList.remove('is-invalid');

      return ok;
    }

    
    document.addEventListener('submit', function(e){
      if(e.target.id !== 'f') return;
      e.preventDefault();
      const fd = new FormData(e.target);
      if(!validate(fd, e.target)) return;
      if(!confirm('게시물을 수정할까요?')) return;

      DB.update(id, {
        name: fd.get('name').trim(),
        qty: Number(fd.get('qty')),
        type: fd.get('type'),
        status: fd.get('status'),
        buy: fd.get('buy'),
        expire: fd.get('expire'),
        price: Number(fd.get('price')),    
        note: (fd.get('note')||'').trim()
      });

      alert('수정되었습니다');
      location.href = 'view.html?id=' + id;  
    });

    render();
  </script>
</body>
</html>
